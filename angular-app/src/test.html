<!doctype html>  
<html>
<body>  
    <div>
        <span>倒计时</span><span id="time">10</span>
    </div>
    <div>
        <canvas id="can" width="400" height="400" style="background: rgb(0, 0, 0)"></canvas>
    </div>
    <div>
        <button onclick="start()">开始</button>
        <button id="reset" onclick="reset()">暂停</button>
        <span>得分:</span><span id="score">0</span>
    </div>
    <script>
        const resetBtn = document.getElementById('reset');
        const timeShow = document.getElementById('time');
        const scoreShow = document.getElementById('score');
        let sn = [2, 1], dz = 3, fx = 1, n, timer;
        let arr = Array.apply(null, Array(1600)).map((i, n) => {
            return n;
        });
        var ctx = document.getElementById('can').getContext('2d');
        function draw(t, c){
            ctx.fillStyle = c;
            ctx.fillRect(t % 40 * 10 + 1, ~~(t / 40) * 10 + 1, 9, 9);
        }
        document.onkeydown = function(ev){
            ev = ev || event;
            if(ev.keyCode === 13){
                start()
            }else if(ev.keyCode === 32){
                reset()
            }
            let n = [ -1, -40, 1, 40 ][ev.keyCode - 37] || fx;
            fx = sn[1] - sn[0] === n ? fx : n;
        }
        //开始程序
        const start = function() {
            sn = [2, 1], dz = 3, fx = 1, n;
            scoreShow.innerHTML = 0;
            timeShow.innerHTML = 10;
            ctx.clearRect(0, 0, 400, 400);
            if(timer){
                clearTimeout(timer);
            }
            main();
            score();
            time();
        }
        let bar = []
        const main = function(){
            n = sn[0]+fx
            if(sn.indexOf(n)>0 || n<0 || n>1600 || n%40 === 39 && fx === -1 || n%40 === 0 && fx ===1)
                return console.error('Game Over!');
            sn.unshift(n);
            bar = arr.filter((i, index) => {
                var flag = true;
                sn.forEach(function(el, index){
                    if(el === i){
                        flag = false;
                    }
                })
                return flag;
            })
            draw(n, "Lime"); 
            if(n === dz){
                score()
                time()
                dz = bar[Math.floor((Math.random())*bar.length)];
                if(!dz && dz !== 0)
                return console.info('You Win!');
                draw(dz, 'Yellow');
            }else {
                draw(sn.pop(), 'black');
            }
            timer = setTimeout(arguments.callee, 100-sn.length*10>50?100-sn.length*10:50);
        }
        const reset = function(){
            resetBtn.onclick = goContinue;
            resetBtn.innerHTML = '继续';
            if(timer){
                clearTimeout(timer)
            }
        }
        const goContinue = function(){
            resetBtn.onclick = reset;
            resetBtn.innerHTML = '暂停';
            clearTimeout(timer);
            timer = setTimeout(main, 100-sn.length*10>50?100-sn.length*10:50);
        }
        //分数模块
        const score = function(){
            scoreShow.innerHTML = +timeShow.innerHTML + +scoreShow.innerHTML;
        }
        
        let timeTimer = null;
        const time = function(){
            if(timeTimer){
                clearInterval(timeTimer)
            }
            timeShow.innerHTML = 10
            timeTimer = setInterval(function(){
                let now = +timeShow.innerHTML-1
                if(now<0){
                    createNewPoint()
                }
                timeShow.innerHTML = now
            }, 1000)
        }
        function createNewPoint(){
            draw(dz, 'black');
            dz = bar[Math.floor((Math.random())*bar.length)];
            draw(dz, 'Yellow');
            time()
        }
    </script>  
</body>  
</html>  